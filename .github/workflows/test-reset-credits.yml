# ğŸ§ª Workflow di test per il reset crediti
# Questo workflow serve per testare l'endpoint senza aspettare il cron giornaliero

name: Test Reset Credits

on:
  # Solo trigger manuale
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'ModalitÃ  test'
        required: true
        default: 'dry-run'
        type: choice
        options:
          - dry-run     # Solo preview, no modifiche
          - force-test  # Esegue reset vero (usa con cautela!)

jobs:
  test-reset:
    name: Test Reset Endpoint
    runs-on: ubuntu-latest
    environment: Production
    
    steps:
      - name: ğŸ§ª Test Reset Credits API
        run: |
          echo "ğŸ” Testing reset credits endpoint..."
          echo "Mode: ${{ github.event.inputs.test_mode }}"
          
          # URL base
          BASE_URL="${{ secrets.APP_URL }}/api/cron/reset-credits"
          
          # Headers
          HEADERS=(
            -H "Content-Type: application/json"
            -H "User-Agent: GitHub-Actions-Test/1.0"
          )
          
          # Aggiungi auth se presente
          if [[ -n "${{ secrets.CRON_SECRET }}" ]]; then
            HEADERS+=(-H "Authorization: Bearer ${{ secrets.CRON_SECRET }}")
            echo "ğŸ” Using authentication"
          else
            echo "âš ï¸ No CRON_SECRET found - endpoint might reject request"
          fi
          
          # ModalitÃ  dry-run: solo GET per preview
          if [[ "${{ github.event.inputs.test_mode }}" == "dry-run" ]]; then
            echo "ğŸ” DRY RUN - Getting preview of users to reset..."
            
            response=$(curl -s -w "HTTPSTATUS:%{http_code}" -X GET "$BASE_URL" "${HEADERS[@]}")
            
            http_code=$(echo "$response" | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
            body=$(echo "$response" | sed -e 's/HTTPSTATUS:.*//g')
            
            echo "ğŸ“Š Preview HTTP Status: $http_code"
            echo "ğŸ“‹ Preview Response:"
            echo "$body" | head -20  # Limita output per GitHub Actions
            
            if [[ "$http_code" -eq 200 ]]; then
              echo "âœ… Endpoint reachable and working"
            else
              echo "âŒ Endpoint test failed"
              exit 1
            fi
            
          # ModalitÃ  force-test: esegue reset vero
          elif [[ "${{ github.event.inputs.test_mode }}" == "force-test" ]]; then
            echo "âš ï¸  FORCE TEST - Executing actual reset!"
            echo "ğŸš¨ This will modify the database!"
            
            response=$(curl -s -w "HTTPSTATUS:%{http_code}" -X POST "$BASE_URL" "${HEADERS[@]}")
            
            http_code=$(echo "$response" | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
            body=$(echo "$response" | sed -e 's/HTTPSTATUS:.*//g')
            
            echo "ğŸ“Š Reset HTTP Status: $http_code"
            echo "ğŸ“‹ Reset Response: $body"
            
            if [[ "$http_code" -eq 200 ]]; then
              echo "âœ… Reset executed successfully"
              
              # Parse risultati se possibile
              if command -v jq &> /dev/null && echo "$body" | jq . &> /dev/null; then
                users_processed=$(echo "$body" | jq -r '.usersProcessed // "N/A"')
                credits_reset=$(echo "$body" | jq -r '.creditsReset // "N/A"')
                echo "ğŸ“ˆ Users processed: $users_processed"
                echo "ğŸ”„ Credits reset: $credits_reset"
              fi
            else
              echo "âŒ Reset failed"
              exit 1
            fi
          fi

      - name: ğŸ“Š Test Summary
        run: |
          echo "ğŸ¯ Test completed successfully!"
          echo "â° Timestamp: $(date -u)"
          echo "ğŸ”§ Mode: ${{ github.event.inputs.test_mode }}"
          echo "ğŸŒ Endpoint: ${{ secrets.APP_URL }}/api/cron/reset-credits"
          
          if [[ "${{ github.event.inputs.test_mode }}" == "dry-run" ]]; then
            echo "ğŸ’¡ This was a dry run - no data was modified"
            echo "ğŸš€ To test actual reset, run again with 'force-test' mode"
          else
            echo "âš ï¸  This was a live test - data was modified!"
            echo "ğŸ” Check your database to verify the changes"
          fi
